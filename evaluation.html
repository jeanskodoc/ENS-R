<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Sujet d'Évaluation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --light-color: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .institution-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .institution-item {
            flex: 1;
            min-width: 200px;
            text-align: center;
            padding: 10px;
        }
        
        .institution-item strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #e8f4fd;
        }
        
        h1 {
            color: white;
            margin-bottom: 15px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background-color: var(--light-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .tab:hover {
            background-color: #eaeaea;
            transform: translateY(-2px);
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .tab i {
            margin-right: 8px;
            font-size: 1.1em;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .exam-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background-color: var(--light-color);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .exercise {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: var(--light-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .exercise:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .exercise-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .question {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .points {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-info {
            background-color: #17a2b8;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .preview {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 25px;
        }
        
        .preview-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
        }
        
        .preview-title {
            color: var(--secondary-color);
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        .preview-exam-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .preview-exam-info div {
            background: white;
            padding: 8px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 180px;
            text-align: center;
        }
        
        .preview-section {
            margin-bottom: 30px;
        }
        
        .preview-exercise {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px dashed var(--border-color);
        }
        
        .hidden {
            display: none;
        }
        
        .answer-space {
            height: 20px;
            border-bottom: 2px solid #666;
            margin: 12px 0;
            background: repeating-linear-gradient(90deg, transparent, transparent 5px, #f0f0f0 5px, #f0f0f0 10px);
        }
        
        .choices, .true-false {
            margin-left: 20px;
        }
        
        .matching {
            display: flex;
            flex-direction: column;
        }
        
        .match-item {
            display: flex;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .match-left, .match-right {
            width: 45%;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .match-arrow {
            width: 10%;
            text-align: center;
            font-size: 1.1em;
            color: var(--primary-color);
        }
        
        .correction {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 12px;
            border-left: 4px solid var(--primary-color);
        }
        
        .correction h4 {
            margin-top: 0;
            color: var(--secondary-color);
        }
        
        .editor-container {
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .ql-editor {
            min-height: 150px;
            font-size: 15px;
        }
        
        .saved-exams {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .exam-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .exam-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }
        
        .exam-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        .exam-card h3 {
            margin-bottom: 12px;
            color: var(--secondary-color);
            font-size: 1.2em;
        }
        
        .exam-card p {
            margin-bottom: 6px;
            color: #666;
        }
        
        .exam-card-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .latex-output {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 2px solid #34495e;
            border-radius: 8px;
            padding: 18px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            line-height: 1.5;
            font-size: 13px;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 18px;
            background-color: var(--light-color);
            border-radius: 8px;
        }
        
        .filter-controls input, .filter-controls select {
            flex: 1;
            min-width: 200px;
        }
        
        footer {
            text-align: center;
            margin-top: 35px;
            font-size: 0.9em;
            color: #7f8c8d;
            padding: 18px;
            border-top: 1px solid var(--border-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 35px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 2.5em;
            margin-bottom: 12px;
            color: #bdc3c7;
        }
        
        .manual-correction {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px dashed var(--primary-color);
        }
        
        .manual-correction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .manual-correction-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .manual-correction-content {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .correction-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid var(--success-color);
        }
        
        .correction-section-title {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .preview {
                box-shadow: none;
                padding: 0;
            }
            
            body {
                background-color: white;
                padding: 0;
            }
            
            .preview-header {
                background: none;
            }
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .exam-info, .preview-exam-info {
                grid-template-columns: 1fr;
            }
            
            .institution-info {
                flex-direction: column;
                text-align: center;
            }
            
            .institution-item {
                min-width: 100%;
                margin-bottom: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="institution-info">
                    <div class="institution-item">
                        <strong>Établissement</strong>
                        <span id="institution-name">Lycée d'Excellence</span>
                    </div>
                    <div class="institution-item">
                        <strong>Inspection/IESG</strong>
                        <span id="inspection-name">Inspection Académique</span>
                    </div>
                    <div class="institution-item">
                        <strong>DRE</strong>
                        <span id="dre-name">Direction Régionale de l'Éducation</span>
                    </div>
                </div>
                
                <h1><i class="fas fa-graduation-cap"></i> Générateur de Sujet d'Évaluation</h1>
                <p class="header-subtitle">Créez, gérez et exportez facilement vos sujets d'évaluation avec éditeur de texte enrichi et export LaTeX</p>
            </div>
        </header>
        
        <div class="tabs no-print">
            <div class="tab active" data-tab="subject-form">
                <i class="fas fa-edit"></i> Formulaire Sujet
            </div>
            <div class="tab" data-tab="correction-form">
                <i class="fas fa-check-circle"></i> Formulaire Correction
            </div>
            <div class="tab" data-tab="saved-exams">
                <i class="fas fa-archive"></i> Épreuves Sauvegardées
            </div>
            <div class="tab" data-tab="preview">
                <i class="fas fa-eye"></i> Aperçu
            </div>
            <div class="tab" data-tab="latex-export">
                <i class="fas fa-code"></i> Export LaTeX
            </div>
        </div>
        
        <!-- Formulaire pour créer le sujet -->
        <div id="subject-form" class="tab-content active">
            <h2><i class="fas fa-edit"></i> Création du Sujet d'Évaluation</h2>
            
            <div class="form-group">
                <h3>Informations générales</h3>
                <div class="exam-info">
                    <div>
                        <label for="exam-date"><i class="fas fa-calendar-alt"></i> Date</label>
                        <input type="date" id="exam-date">
                    </div>
                    <div>
                        <label for="exam-subject"><i class="fas fa-book"></i> Matière</label>
                        <input type="text" id="exam-subject" placeholder="Ex: Mathématiques">
                    </div>
                    <div>
                        <label for="exam-type"><i class="fas fa-tasks"></i> Type d'épreuve</label>
                        <select id="exam-type">
                            <option value="devoir surveillé">Devoir Surveillé</option>
                            <option value="composition régionale">Composition Régionale</option>
                            <option value="examen blanc">Examen Blanc</option>
                            <option value="contrôle continu">Contrôle Continu</option>
                        </select>
                    </div>
                    <div>
                        <label for="exam-duration"><i class="fas fa-clock"></i> Durée</label>
                        <input type="text" id="exam-duration" placeholder="Ex: 2 heures">
                    </div>
                    <div>
                        <label for="teacher-name"><i class="fas fa-user"></i> Nom de l'enseignant</label>
                        <input type="text" id="teacher-name" placeholder="Ex: M. DUPONT">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <h3>Paramètres institutionnels</h3>
                <div class="exam-info">
                    <div>
                        <label for="institution-name-input"><i class="fas fa-school"></i> Établissement</label>
                        <input type="text" id="institution-name-input" placeholder="Nom de l'établissement">
                    </div>
                    <div>
                        <label for="inspection-name-input"><i class="fas fa-user-tie"></i> Inspection/IESG</label>
                        <input type="text" id="inspection-name-input" placeholder="Nom de l'inspection">
                    </div>
                    <div>
                        <label for="dre-name-input"><i class="fas fa-map-marker-alt"></i> DRE</label>
                        <input type="text" id="dre-name-input" placeholder="Direction Régionale">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <h3>Exercices</h3>
                <div id="exercises-container">
                    <!-- Les exercices seront ajoutés ici dynamiquement -->
                </div>
                <button type="button" id="add-exercise" class="btn"><i class="fas fa-plus"></i> Ajouter un exercice</button>
            </div>
            
            <div class="actions">
                <div class="action-buttons">
                    <button type="button" id="save-subject" class="btn btn-success"><i class="fas fa-save"></i> Enregistrer le sujet</button>
                    <button type="button" id="preview-subject" class="btn"><i class="fas fa-eye"></i> Aperçu du sujet</button>
                    <button type="button" id="generate-latex" class="btn btn-warning"><i class="fas fa-code"></i> Générer LaTeX</button>
                </div>
            </div>
        </div>
        
        <!-- Formulaire pour créer la correction -->
        <div id="correction-form" class="tab-content">
            <h2><i class="fas fa-check-circle"></i> Correction du Sujet</h2>
            
            <div class="correction-section">
                <div class="correction-section-title">
                    <i class="fas fa-info-circle"></i> Informations de l'évaluation
                </div>
                <div class="exam-info">
                    <div>
                        <label>Date</label>
                        <div id="correction-exam-date">-</div>
                    </div>
                    <div>
                        <label>Matière</label>
                        <div id="correction-exam-subject">-</div>
                    </div>
                    <div>
                        <label>Type d'épreuve</label>
                        <div id="correction-exam-type">-</div>
                    </div>
                    <div>
                        <label>Durée</label>
                        <div id="correction-exam-duration">-</div>
                    </div>
                    <div>
                        <label>Enseignant</label>
                        <div id="correction-teacher-name">-</div>
                    </div>
                </div>
            </div>
            
            <div class="correction-section">
                <div class="correction-section-title">
                    <i class="fas fa-tasks"></i> Corrections des exercices
                </div>
                <div id="corrections-container">
                    <!-- Les corrections seront ajoutées ici dynamiquement -->
                </div>
            </div>
            
            <div class="manual-correction">
                <div class="manual-correction-header">
                    <div class="manual-correction-title">
                        <i class="fas fa-pen-alt"></i> Rédaction manuelle de la solution complète
                    </div>
                </div>
                <div class="manual-correction-content">
                    <div class="form-group">
                        <label>Solution complète de l'évaluation</label>
                        <div id="manual-correction-editor" class="editor-container"></div>
                        <p class="help-text" style="color: #666; font-size: 0.9em; margin-top: 5px;">
                            Utilisez cet éditeur pour rédiger la solution complète de l'évaluation avec explications détaillées, méthodes de résolution, et remarques pédagogiques.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <div class="action-buttons">
                    <button type="button" id="save-correction" class="btn btn-success"><i class="fas fa-save"></i> Enregistrer la correction</button>
                    <button type="button" id="preview-correction" class="btn"><i class="fas fa-eye"></i> Aperçu de la correction</button>
                    <button type="button" id="load-exam-for-correction" class="btn"><i class="fas fa-file-import"></i> Charger une évaluation</button>
                    <button type="button" id="sync-subject-to-correction" class="btn btn-info"><i class="fas fa-sync-alt"></i> Synchroniser avec le sujet</button>
                </div>
            </div>
        </div>
        
        <!-- Épreuves sauvegardées -->
        <div id="saved-exams" class="tab-content">
            <h2><i class="fas fa-archive"></i> Épreuves Sauvegardées</h2>
            
            <div class="filter-controls">
                <input type="text" id="search-exams" placeholder="Rechercher par matière, type ou enseignant...">
                <select id="filter-type">
                    <option value="">Tous les types</option>
                    <option value="devoir surveillé">Devoir Surveillé</option>
                    <option value="composition régionale">Composition Régionale</option>
                    <option value="examen blanc">Examen Blanc</option>
                    <option value="contrôle continu">Contrôle Continu</option>
                </select>
                <input type="date" id="filter-date">
            </div>
            
            <div id="saved-exams-list" class="saved-exams">
                <!-- Les épreuves sauvegardées seront affichées ici -->
            </div>
        </div>
        
        <!-- Aperçu du sujet -->
        <div id="preview" class="tab-content">
            <div class="preview" id="subject-preview">
                <div class="preview-header">
                    <h1 class="preview-title">SUJET D'ÉVALUATION</h1>
                    <div class="preview-exam-info" id="preview-exam-info">
                        <!-- Les informations de l'examen seront insérées ici -->
                    </div>
                </div>
                
                <div id="preview-exercises">
                    <!-- Les exercices seront insérés ici -->
                </div>
                
                <footer>
                    <p id="preview-total-points">BARÈME TOTAL : 0 points</p>
                    <p>Bon courage !</p>
                </footer>
            </div>
            
            <div class="preview hidden" id="correction-preview">
                <div class="preview-header">
                    <h1 class="preview-title">CORRIGÉ TYPE</h1>
                    <div class="preview-exam-info" id="preview-correction-info">
                        <!-- Les informations de correction seront insérées ici -->
                    </div>
                </div>
                
                <div id="preview-corrections">
                    <!-- Les corrections seront insérés ici -->
                </div>
                
                <div class="manual-correction" id="preview-manual-correction">
                    <div class="manual-correction-header">
                        <div class="manual-correction-title">
                            <i class="fas fa-pen-alt"></i> Solution complète
                        </div>
                    </div>
                    <div class="manual-correction-content" id="preview-manual-correction-content">
                        <!-- Le contenu de la correction manuelle sera inséré ici -->
                    </div>
                </div>
            </div>
            
            <div class="actions no-print">
                <div class="action-buttons">
                    <button type="button" id="print-subject" class="btn"><i class="fas fa-print"></i> Imprimer le sujet</button>
                    <button type="button" id="print-correction" class="btn"><i class="fas fa-print"></i> Imprimer la correction</button>
                </div>
            </div>
        </div>
        
        <!-- Export LaTeX -->
        <div id="latex-export" class="tab-content">
            <h2><i class="fas fa-code"></i> Export LaTeX</h2>
            
            <div class="actions">
                <div class="action-buttons">
                    <button type="button" id="generate-latex-subject" class="btn"><i class="fas fa-code"></i> Générer LaTeX du sujet</button>
                    <button type="button" id="generate-latex-correction" class="btn"><i class="fas fa-code"></i> Générer LaTeX de la correction</button>
                    <button type="button" id="sync-and-generate-correction" class="btn btn-info"><i class="fas fa-sync-alt"></i> Synchroniser et générer LaTeX corrigé</button>
                    <button type="button" id="copy-latex" class="btn btn-success"><i class="fas fa-copy"></i> Copier le code</button>
                </div>
            </div>
            
            <div class="latex-output" id="latex-output">
                <!-- Le code LaTeX sera affiché ici -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // Données globales
        let examData = {
            id: null,
            date: '',
            subject: '',
            type: '',
            duration: '',
            teacher: '',
            institution: '',
            inspection: '',
            dre: '',
            exercises: [],
            corrections: [],
            manualCorrection: '',
            createdAt: new Date().toISOString()
        };
        
        let savedExams = JSON.parse(localStorage.getItem('savedExams')) || [];
        let editors = [];
        let manualCorrectionEditor = null;
        
        // Templates pour les exercices
        const exerciseTypes = {
            'situation': 'Situation d\'évaluation',
            'qcm': 'Questions à choix multiple',
            'true-false': 'Vrai ou Faux',
            'fill-blanks': 'Questions à trous',
            'matching': 'Mots à relier',
            'definitions': 'Définitions',
            'traditional': 'Questions traditionnelles'
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Gestion des onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    
                    if (this.dataset.tab === 'saved-exams') {
                        loadSavedExams();
                    } else if (this.dataset.tab === 'correction-form') {
                        updateCorrectionFormInfo();
                    }
                });
            });
            
            // Ajout d'un exercice
            document.getElementById('add-exercise').addEventListener('click', addExercise);
            
            // Enregistrement du sujet
            document.getElementById('save-subject').addEventListener('click', saveSubject);
            
            // Enregistrement de la correction
            document.getElementById('save-correction').addEventListener('click', saveCorrection);
            
            // Aperçu du sujet
            document.getElementById('preview-subject').addEventListener('click', function() {
                saveSubject();
                document.querySelector('.tab[data-tab="preview"]').click();
                previewSubject();
            });
            
            // Aperçu de la correction
            document.getElementById('preview-correction').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="preview"]').click();
                previewCorrection();
            });
            
            // Génération LaTeX
            document.getElementById('generate-latex').addEventListener('click', function() {
                saveSubject();
                document.querySelector('.tab[data-tab="latex-export"]').click();
                generateLatexSubject();
            });
            
            document.getElementById('generate-latex-subject').addEventListener('click', generateLatexSubject);
            document.getElementById('generate-latex-correction').addEventListener('click', generateLatexCorrection);
            document.getElementById('sync-and-generate-correction').addEventListener('click', syncAndGenerateLatexCorrection);
            document.getElementById('copy-latex').addEventListener('click', copyLatexToClipboard);
            
            // Synchronisation sujet -> correction
            document.getElementById('sync-subject-to-correction').addEventListener('click', syncSubjectToCorrection);
            
            // Impression
            document.getElementById('print-subject').addEventListener('click', function() {
                window.print();
            });
            
            document.getElementById('print-correction').addEventListener('click', function() {
                document.getElementById('subject-preview').classList.add('hidden');
                document.getElementById('correction-preview').classList.remove('hidden');
                window.print();
                document.getElementById('subject-preview').classList.remove('hidden');
                document.getElementById('correction-preview').classList.add('hidden');
            });
            
            // Filtres pour les épreuves sauvegardées
            document.getElementById('search-exams').addEventListener('input', loadSavedExams);
            document.getElementById('filter-type').addEventListener('change', loadSavedExams);
            document.getElementById('filter-date').addEventListener('change', loadSavedExams);
            
            // Mise à jour de l'en-tête
            document.getElementById('institution-name-input').addEventListener('input', updateHeader);
            document.getElementById('inspection-name-input').addEventListener('input', updateHeader);
            document.getElementById('dre-name-input').addEventListener('input', updateHeader);
            
            // Charger une évaluation pour correction
            document.getElementById('load-exam-for-correction').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="saved-exams"]').click();
            });
            
            // Initialiser l'éditeur de correction manuelle
            manualCorrectionEditor = new Quill('#manual-correction-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['formula'],
                        ['clean']
                    ]
                },
                placeholder: 'Rédigez ici la solution complète de l\'évaluation avec toutes les explications nécessaires...'
            });
            
            // Ajouter un exercice par défaut
            addExercise();
            
            // Charger les épreuves sauvegardées
            loadSavedExams();
        });
        
        // Fonction pour synchroniser le contenu du sujet avec le formulaire de correction
        function syncSubjectToCorrection() {
            saveSubject(); // S'assurer que le sujet est à jour
            
            // Mettre à jour les informations de correction avec les données du sujet
            updateCorrectionFormInfo();
            
            // Reconstruire les formulaires de correction pour correspondre aux exercices du sujet
            document.getElementById('corrections-container').innerHTML = '';
            examData.exercises.forEach(exercise => {
                renderCorrectionForm(exercise.id);
            });
            
            alert('Contenu du sujet synchronisé avec le formulaire de correction!');
        }
        
        // Fonction pour synchroniser et générer le LaTeX de correction
        function syncAndGenerateLatexCorrection() {
            syncSubjectToCorrection();
            generateLatexCorrection();
        }
        
        // Fonction pour mettre à jour l'en-tête
        function updateHeader() {
            const institutionName = document.getElementById('institution-name-input').value || 'Lycée d\'Excellence';
            const inspectionName = document.getElementById('inspection-name-input').value || 'Inspection Académique';
            const dreName = document.getElementById('dre-name-input').value || 'Direction Régionale de l\'Éducation';
            
            document.getElementById('institution-name').textContent = institutionName;
            document.getElementById('inspection-name').textContent = inspectionName;
            document.getElementById('dre-name').textContent = dreName;
        }
        
        // Fonction pour mettre à jour les informations dans le formulaire de correction
        function updateCorrectionFormInfo() {
            document.getElementById('correction-exam-date').textContent = examData.date ? formatDate(examData.date) : '-';
            document.getElementById('correction-exam-subject').textContent = examData.subject || '-';
            document.getElementById('correction-exam-type').textContent = examData.type || '-';
            document.getElementById('correction-exam-duration').textContent = examData.duration || '-';
            document.getElementById('correction-teacher-name').textContent = examData.teacher || '-';
            
            // Charger la correction manuelle si elle existe
            if (manualCorrectionEditor && examData.manualCorrection) {
                manualCorrectionEditor.root.innerHTML = examData.manualCorrection;
            }
        }
        
        // Fonction pour ajouter un exercice
        function addExercise() {
            const exerciseId = examData.exercises.length;
            examData.exercises.push({
                id: exerciseId,
                title: '',
                type: 'situation',
                instructions: '',
                questions: []
            });
            
            examData.corrections.push({
                exerciseId: exerciseId,
                answers: []
            });
            
            renderExerciseForm(exerciseId);
            renderCorrectionForm(exerciseId);
        }
        
        // Fonction pour afficher le formulaire d'un exercice
        function renderExerciseForm(exerciseId) {
            const container = document.getElementById('exercises-container');
            
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'exercise';
            exerciseDiv.id = `exercise-${exerciseId}`;
            
            exerciseDiv.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-title">Exercice ${romanize(exerciseId + 1)}</div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeExercise(${exerciseId})"><i class="fas fa-trash"></i> Supprimer</button>
                </div>
                <div class="form-group">
                    <label for="exercise-title-${exerciseId}">Titre de l'exercice</label>
                    <input type="text" id="exercise-title-${exerciseId}" placeholder="Ex: Situation d'évaluation">
                </div>
                <div class="form-group">
                    <label for="exercise-type-${exerciseId}">Type d'exercice</label>
                    <select id="exercise-type-${exerciseId}">
                        ${Object.entries(exerciseTypes).map(([key, value]) => 
                            `<option value="${key}">${value}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="exercise-instructions-${exerciseId}">Instructions</label>
                    <div id="exercise-instructions-editor-${exerciseId}" class="editor-container"></div>
                </div>
                <div class="form-group">
                    <h4>Questions</h4>
                    <div id="questions-container-${exerciseId}">
                        <!-- Les questions seront ajoutées ici -->
                    </div>
                    <button type="button" class="btn btn-sm" onclick="addQuestion(${exerciseId})"><i class="fas fa-plus"></i> Ajouter une question</button>
                </div>
            `;
            
            container.appendChild(exerciseDiv);
            
            // Initialiser l'éditeur de texte enrichi
            const instructionsEditor = new Quill(`#exercise-instructions-editor-${exerciseId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Instructions pour cet exercice...'
            });
            
            editors.push({
                type: 'instructions',
                exerciseId: exerciseId,
                editor: instructionsEditor
            });
            
            // Ajouter un événement pour mettre à jour le type d'exercice
            document.getElementById(`exercise-type-${exerciseId}`).addEventListener('change', function() {
                updateExerciseType(exerciseId, this.value);
            });
            
            // Ajouter une question par défaut
            addQuestion(exerciseId);
        }
        
        // Fonction pour afficher le formulaire de correction d'un exercice
        function renderCorrectionForm(exerciseId) {
            const container = document.getElementById('corrections-container');
            
            const correctionDiv = document.createElement('div');
            correctionDiv.className = 'exercise';
            correctionDiv.id = `correction-${exerciseId}`;
            
            correctionDiv.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-title">Correction - Exercice ${romanize(exerciseId + 1)}</div>
                </div>
                <div class="form-group">
                    <div id="correction-questions-${exerciseId}">
                        <!-- Les corrections de questions seront ajoutées ici -->
                    </div>
                </div>
            `;
            
            container.appendChild(correctionDiv);
            
            // Rendre les corrections pour chaque question existante
            examData.exercises[exerciseId].questions.forEach(question => {
                renderCorrectionQuestion(exerciseId, question.id);
            });
        }
        
        // Fonction pour ajouter une question à un exercice
        function addQuestion(exerciseId) {
            const questionId = examData.exercises[exerciseId].questions.length;
            examData.exercises[exerciseId].questions.push({
                id: questionId,
                text: '',
                points: 1
            });
            
            examData.corrections[exerciseId].answers.push('');
            
            renderQuestionForm(exerciseId, questionId);
            renderCorrectionQuestion(exerciseId, questionId);
        }
        
        // Fonction pour afficher le formulaire d'une question
        function renderQuestionForm(exerciseId, questionId) {
            const container = document.getElementById(`questions-container-${exerciseId}`);
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';
            questionDiv.id = `question-${exerciseId}-${questionId}`;
            
            questionDiv.innerHTML = `
                <div class="question-header">
                    <div>Question ${questionId + 1}</div>
                    <div>
                        <label for="question-points-${exerciseId}-${questionId}">Points:</label>
                        <input type="number" id="question-points-${exerciseId}-${questionId}" min="0" step="0.5" value="1" style="width: 70px;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="question-text-${exerciseId}-${questionId}">Texte de la question</label>
                    <div id="question-text-editor-${exerciseId}-${questionId}" class="editor-container"></div>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(${exerciseId}, ${questionId})"><i class="fas fa-trash"></i> Supprimer cette question</button>
            `;
            
            container.appendChild(questionDiv);
            
            // Initialiser l'éditeur de texte enrichi pour la question
            const questionEditor = new Quill(`#question-text-editor-${exerciseId}-${questionId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Entrez le texte de la question...'
            });
            
            editors.push({
                type: 'question',
                exerciseId: exerciseId,
                questionId: questionId,
                editor: questionEditor
            });
        }
        
        // Fonction pour afficher la correction d'une question
        function renderCorrectionQuestion(exerciseId, questionId) {
            const container = document.getElementById(`correction-questions-${exerciseId}`);
            
            const correctionDiv = document.createElement('div');
            correctionDiv.className = 'question';
            correctionDiv.id = `correction-question-${exerciseId}-${questionId}`;
            
            correctionDiv.innerHTML = `
                <div class="question-header">
                    <div>Correction - Question ${questionId + 1}</div>
                </div>
                <div class="form-group">
                    <label for="correction-answer-${exerciseId}-${questionId}">Réponse</label>
                    <div id="correction-answer-editor-${exerciseId}-${questionId}" class="editor-container"></div>
                </div>
            `;
            
            container.appendChild(correctionDiv);
            
            // Initialiser l'éditeur de texte enrichi pour la correction
            const correctionEditor = new Quill(`#correction-answer-editor-${exerciseId}-${questionId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Entrez la réponse correcte...'
            });
            
            editors.push({
                type: 'correction',
                exerciseId: exerciseId,
                questionId: questionId,
                editor: correctionEditor
            });
        }
        
        // Fonction pour supprimer un exercice
        function removeExercise(exerciseId) {
            if (examData.exercises.length > 1) {
                examData.exercises.splice(exerciseId, 1);
                examData.corrections.splice(exerciseId, 1);
                
                // Réorganiser les IDs
                examData.exercises.forEach((ex, idx) => ex.id = idx);
                examData.corrections.forEach((cor, idx) => cor.exerciseId = idx);
                
                // Re-rendre tous les formulaires
                renderAllForms();
            } else {
                alert('Vous devez avoir au moins un exercice.');
            }
        }
        
        // Fonction pour supprimer une question
        function removeQuestion(exerciseId, questionId) {
            const exercise = examData.exercises[exerciseId];
            if (exercise.questions.length > 1) {
                exercise.questions.splice(questionId, 1);
                examData.corrections[exerciseId].answers.splice(questionId, 1);
                
                // Réorganiser les IDs
                exercise.questions.forEach((q, idx) => q.id = idx);
                
                // Re-rendre l'exercice
                renderExerciseForm(exerciseId);
                renderCorrectionForm(exerciseId);
            } else {
                alert('Vous devez avoir au moins une question par exercice.');
            }
        }
        
        // Fonction pour re-rendre tous les formulaires
        function renderAllForms() {
            document.getElementById('exercises-container').innerHTML = '';
            document.getElementById('corrections-container').innerHTML = '';
            editors = [];
            
            examData.exercises.forEach(exercise => {
                renderExerciseForm(exercise.id);
                renderCorrectionForm(exercise.id);
            });
        }
        
        // Fonction pour mettre à jour le type d'exercice
        function updateExerciseType(exerciseId, type) {
            // Cette fonction pourrait adapter l'interface en fonction du type d'exercice
            console.log(`Exercice ${exerciseId} changé en type: ${type}`);
        }
        
        // Fonction pour enregistrer les données du sujet
        function saveSubject() {
            // Enregistrer les informations générales
            examData.date = document.getElementById('exam-date').value;
            examData.subject = document.getElementById('exam-subject').value;
            examData.type = document.getElementById('exam-type').value;
            examData.duration = document.getElementById('exam-duration').value;
            examData.teacher = document.getElementById('teacher-name').value;
            
            // Enregistrer les informations institutionnelles
            examData.institution = document.getElementById('institution-name-input').value;
            examData.inspection = document.getElementById('inspection-name-input').value;
            examData.dre = document.getElementById('dre-name-input').value;
            
            // Enregistrer les exercices et questions
            examData.exercises.forEach(exercise => {
                exercise.title = document.getElementById(`exercise-title-${exercise.id}`).value;
                exercise.type = document.getElementById(`exercise-type-${exercise.id}`).value;
                
                // Récupérer le contenu de l'éditeur d'instructions
                const instructionsEditor = editors.find(e => 
                    e.type === 'instructions' && e.exerciseId === exercise.id
                );
                if (instructionsEditor) {
                    exercise.instructions = instructionsEditor.editor.root.innerHTML;
                }
                
                exercise.questions.forEach(question => {
                    // Récupérer le contenu de l'éditeur de question
                    const questionEditor = editors.find(e => 
                        e.type === 'question' && e.exerciseId === exercise.id && e.questionId === question.id
                    );
                    if (questionEditor) {
                        question.text = questionEditor.editor.root.innerHTML;
                    }
                    
                    question.points = parseFloat(document.getElementById(`question-points-${exercise.id}-${question.id}`).value);
                });
            });
            
            // Générer un ID si nécessaire
            if (!examData.id) {
                examData.id = 'exam_' + new Date().getTime();
            }
            
            // Mettre à jour l'en-tête
            updateHeader();
            
            alert('Sujet enregistré avec succès!');
        }
        
        // Fonction pour enregistrer les corrections
        function saveCorrection() {
            saveSubject(); // S'assurer que le sujet est à jour
            
            // Enregistrer les corrections
            examData.corrections.forEach(correction => {
                correction.answers = [];
                examData.exercises[correction.exerciseId].questions.forEach(question => {
                    // Récupérer le contenu de l'éditeur de correction
                    const correctionEditor = editors.find(e => 
                        e.type === 'correction' && e.exerciseId === correction.exerciseId && e.questionId === question.id
                    );
                    if (correctionEditor) {
                        correction.answers.push(correctionEditor.editor.root.innerHTML);
                    } else {
                        correction.answers.push('');
                    }
                });
            });
            
            // Enregistrer la correction manuelle
            if (manualCorrectionEditor) {
                examData.manualCorrection = manualCorrectionEditor.root.innerHTML;
            }
            
            // Sauvegarder dans le localStorage
            const existingIndex = savedExams.findIndex(exam => exam.id === examData.id);
            if (existingIndex !== -1) {
                savedExams[existingIndex] = {...examData};
            } else {
                savedExams.push({...examData});
            }
            
            localStorage.setItem('savedExams', JSON.stringify(savedExams));
            
            alert('Correction enregistrée avec succès!');
        }
        
        // Fonction pour afficher l'aperçu du sujet
        function previewSubject() {
            const previewInfo = document.getElementById('preview-exam-info');
            previewInfo.innerHTML = `
                <div><strong>Date :</strong> ${formatDate(examData.date)}</div>
                <div><strong>Matière :</strong> ${examData.subject}</div>
                <div><strong>Type :</strong> ${examData.type}</div>
                <div><strong>Durée :</strong> ${examData.duration}</div>
                <div><strong>Enseignant :</strong> ${examData.teacher}</div>
                <div><strong>Établissement :</strong> ${examData.institution || 'Lycée d\'Excellence'}</div>
            `;
            
            const previewExercises = document.getElementById('preview-exercises');
            previewExercises.innerHTML = '';
            
            let totalPoints = 0;
            
            examData.exercises.forEach(exercise => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'preview-section';
                
                let exercisePoints = 0;
                let questionsHTML = '';
                
                exercise.questions.forEach(question => {
                    exercisePoints += question.points;
                    
                    questionsHTML += `
                        <div class="question">
                            <div class="question-header">
                                <div><strong>Question :</strong> ${question.text}</div>
                                <div class="points">${question.points} point(s)</div>
                            </div>
                            <div class="answer-space"></div>
                        </div>
                    `;
                });
                
                totalPoints += exercisePoints;
                
                exerciseDiv.innerHTML = `
                    <h2>EXERCICE ${romanize(exercise.id + 1)} - ${exercise.title.toUpperCase()} (${exercisePoints} points)</h2>
                    <div class="preview-exercise">
                        <p><strong>Instructions :</strong> ${exercise.instructions}</p>
                        ${questionsHTML}
                    </div>
                `;
                
                previewExercises.appendChild(exerciseDiv);
            });
            
            document.getElementById('preview-total-points').textContent = `BARÈME TOTAL : ${totalPoints} points`;
            
            // Afficher l'aperçu du sujet
            document.getElementById('subject-preview').classList.remove('hidden');
            document.getElementById('correction-preview').classList.add('hidden');
        }
        
        // Fonction pour afficher l'aperçu de la correction
        function previewCorrection() {
            const previewInfo = document.getElementById('preview-correction-info');
            previewInfo.innerHTML = `
                <div><strong>Date :</strong> ${formatDate(examData.date)}</div>
                <div><strong>Matière :</strong> ${examData.subject}</div>
                <div><strong>Type :</strong> ${examData.type}</div>
                <div><strong>Durée :</strong> ${examData.duration}</div>
                <div><strong>Enseignant :</strong> ${examData.teacher}</div>
                <div><strong>Établissement :</strong> ${examData.institution || 'Lycée d\'Excellence'}</div>
            `;
            
            const previewCorrections = document.getElementById('preview-corrections');
            previewCorrections.innerHTML = '';
            
            examData.exercises.forEach(exercise => {
                const correction = examData.corrections.find(c => c.exerciseId === exercise.id);
                
                const correctionDiv = document.createElement('div');
                correctionDiv.className = 'preview-section';
                
                let answersHTML = '';
                
                exercise.questions.forEach((question, index) => {
                    answersHTML += `
                        <div class="question">
                            <div class="question-header">
                                <div><strong>Question ${index + 1} :</strong> ${question.text}</div>
                                <div class="points">${question.points} point(s)</div>
                            </div>
                            <div class="correction">
                                <p><strong>Réponse :</strong> ${correction.answers[index]}</p>
                            </div>
                        </div>
                    `;
                });
                
                correctionDiv.innerHTML = `
                    <h2>CORRECTION - EXERCICE ${romanize(exercise.id + 1)}</h2>
                    <div class="preview-exercise">
                        ${answersHTML}
                    </div>
                `;
                
                previewCorrections.appendChild(correctionDiv);
            });
            
            // Afficher la correction manuelle
            const manualCorrectionPreview = document.getElementById('preview-manual-correction-content');
            if (examData.manualCorrection) {
                manualCorrectionPreview.innerHTML = examData.manualCorrection;
                document.getElementById('preview-manual-correction').classList.remove('hidden');
            } else {
                document.getElementById('preview-manual-correction').classList.add('hidden');
            }
            
            // Afficher l'aperçu de la correction
            document.getElementById('subject-preview').classList.add('hidden');
            document.getElementById('correction-preview').classList.remove('hidden');
        }
        
        // Fonction pour charger les épreuves sauvegardées
        function loadSavedExams() {
            const searchTerm = document.getElementById('search-exams').value.toLowerCase();
            const filterType = document.getElementById('filter-type').value;
            const filterDate = document.getElementById('filter-date').value;
            
            const filteredExams = savedExams.filter(exam => {
                const matchesSearch = !searchTerm || 
                    exam.subject.toLowerCase().includes(searchTerm) ||
                    exam.type.toLowerCase().includes(searchTerm) ||
                    exam.teacher.toLowerCase().includes(searchTerm);
                
                const matchesType = !filterType || exam.type === filterType;
                
                const matchesDate = !filterDate || exam.date === filterDate;
                
                return matchesSearch && matchesType && matchesDate;
            });
            
            const container = document.getElementById('saved-exams-list');
            
            if (filteredExams.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Aucune épreuve trouvée</h3>
                        <p>Aucune épreuve sauvegardée ne correspond aux critères de recherche.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            filteredExams.forEach(exam => {
                const examCard = document.createElement('div');
                examCard.className = 'exam-card';
                
                // Vérifier si l'évaluation a une correction
                const hasCorrection = exam.corrections && exam.corrections.some(c => 
                    c.answers && c.answers.some(a => a && a.trim() !== '')
                ) || exam.manualCorrection;
                
                examCard.innerHTML = `
                    <h3>${exam.subject} - ${exam.type}</h3>
                    <p><strong>Date:</strong> ${formatDate(exam.date)}</p>
                    <p><strong>Durée:</strong> ${exam.duration}</p>
                    <p><strong>Enseignant:</strong> ${exam.teacher}</p>
                    <p><strong>Établissement:</strong> ${exam.institution || 'Non spécifié'}</p>
                    <p><strong>Exercices:</strong> ${exam.exercises.length}</p>
                    <p><strong>Statut correction:</strong> ${hasCorrection ? '<span style="color: var(--success-color);">Complète</span>' : '<span style="color: var(--accent-color);">À compléter</span>'}</p>
                    <div class="exam-card-actions">
                        <button type="button" class="btn btn-sm" onclick="loadExam('${exam.id}')"><i class="fas fa-edit"></i> Modifier</button>
                        <button type="button" class="btn btn-sm" onclick="loadExamForCorrection('${exam.id}')"><i class="fas fa-check-circle"></i> Corriger</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteExam('${exam.id}')"><i class="fas fa-trash"></i> Supprimer</button>
                    </div>
                `;
                
                container.appendChild(examCard);
            });
        }
        
        // Fonction pour charger une épreuve
        function loadExam(examId) {
            const exam = savedExams.find(e => e.id === examId);
            if (exam) {
                examData = JSON.parse(JSON.stringify(exam));
                renderAllForms();
                
                // Remplir les champs institutionnels
                document.getElementById('institution-name-input').value = examData.institution || '';
                document.getElementById('inspection-name-input').value = examData.inspection || '';
                document.getElementById('dre-name-input').value = examData.dre || '';
                
                updateHeader();
                document.querySelector('.tab[data-tab="subject-form"]').click();
                alert('Épreuve chargée avec succès!');
            }
        }
        
        // Fonction pour charger une épreuve pour correction
        function loadExamForCorrection(examId) {
            const exam = savedExams.find(e => e.id === examId);
            if (exam) {
                examData = JSON.parse(JSON.stringify(exam));
                renderAllForms();
                
                // Remplir les champs institutionnels
                document.getElementById('institution-name-input').value = examData.institution || '';
                document.getElementById('inspection-name-input').value = examData.inspection || '';
                document.getElementById('dre-name-input').value = examData.dre || '';
                
                // Mettre à jour l'éditeur de correction manuelle
                if (manualCorrectionEditor && examData.manualCorrection) {
                    manualCorrectionEditor.root.innerHTML = examData.manualCorrection;
                }
                
                updateCorrectionFormInfo();
                document.querySelector('.tab[data-tab="correction-form"]').click();
                alert('Épreuve chargée pour correction!');
            }
        }
        
        // Fonction pour supprimer une épreuve
        function deleteExam(examId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette épreuve ?')) {
                savedExams = savedExams.filter(exam => exam.id !== examId);
                localStorage.setItem('savedExams', JSON.stringify(savedExams));
                loadSavedExams();
            }
        }
        
        // Fonction pour générer le code LaTeX du sujet
        function generateLatexSubject() {
            saveSubject();
            
            let latexCode = `\\documentclass[12pt,a4paper]{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T1]{fontenc}
\\usepackage[french]{babel}
\\usepackage{amsmath}
\\usepackage{amsfonts}
\\usepackage{amssymb}
\\usepackage{graphicx}
\\usepackage{enumitem}
\\usepackage{geometry}
\\usepackage{xcolor}
\\usepackage{titlesec}
\\usepackage{fancyhdr}

\\geometry{left=2cm,right=2cm,top=2cm,bottom=2cm}

\\pagestyle{fancy}
\\fancyhf{}
\\fancyhead[L]{\\textbf{${examData.institution || 'Établissement'}}}
\\fancyhead[C]{\\textbf{${examData.subject} - ${examData.type}}}
\\fancyhead[R]{\\textbf{${formatDate(examData.date)}}}
\\fancyfoot[C]{\\thepage}

\\titleformat{\\section}{\\Large\\bfseries}{}{0pt}{}

\\title{${examData.subject} - ${examData.type}}
\\author{${examData.teacher}}
\\date{${formatDate(examData.date)}}

\\begin{document}

\\maketitle

\\vspace{1cm}

\\begin{center}
    \\textbf{\\Large SUJET D'ÉVALUATION}
\\end{center}

\\vspace{0.5cm}

\\begin{tabular}{|p{0.25\\textwidth}|p{0.7\\textwidth}|}
    \\hline
    \\textbf{Date} & ${formatDate(examData.date)} \\\\
    \\hline
    \\textbf{Matière} & ${examData.subject} \\\\
    \\hline
    \\textbf{Type d'épreuve} & ${examData.type} \\\\
    \\hline
    \\textbf{Durée} & ${examData.duration} \\\\
    \\hline
    \\textbf{Enseignant} & ${examData.teacher} \\\\
    \\hline
    \\textbf{Établissement} & ${examData.institution || 'Non spécifié'} \\\\
    \\hline
    \\textbf{Inspection/IESG} & ${examData.inspection || 'Non spécifié'} \\\\
    \\hline
    \\textbf{DRE} & ${examData.dre || 'Non spécifié'} \\\\
    \\hline
\\end{tabular}

\\vspace{1cm}

\\noindent\\textbf{Instructions générales:}
\\begin{itemize}
    \\item L'usage de la calculatrice est interdit sauf mention contraire.
    \\item La clarté des raisonnements et la qualité de la rédaction seront prises en compte.
    \\item Le barème est donné à titre indicatif.
\\end{itemize}

\\vspace{1cm}
`;
            
            let totalPoints = 0;
            
            examData.exercises.forEach(exercise => {
                let exercisePoints = 0;
                exercise.questions.forEach(q => exercisePoints += q.points);
                totalPoints += exercisePoints;
                
                latexCode += `\\section*{Exercice ${romanize(exercise.id + 1)} : ${exercise.title} (${exercisePoints} points)}

${htmlToLatex(exercise.instructions)}

\\begin{enumerate}[label=\\textbf{\\arabic*.}, wide]
`;
                
                exercise.questions.forEach(question => {
                    latexCode += `    \\item[\\hspace{1cm}] ${htmlToLatex(question.text)}
    \\hfill \\textbf{(${question.points} point${question.points > 1 ? 's' : ''})}
    
    \\vspace{1cm}
`;
                });
                
                latexCode += `\\end{enumerate}

\\vspace{0.5cm}
`;
            });
            
            latexCode += `\\vfill

\\begin{center}
    \\framebox[0.9\\textwidth]{\\textbf{Barème total: ${totalPoints} points}}
\\end{center}

\\end{document}`;
            
            document.getElementById('latex-output').textContent = latexCode;
        }
        
        // Fonction pour générer le code LaTeX de la correction
        function generateLatexCorrection() {
            saveCorrection();
            
            let latexCode = `\\documentclass[12pt,a4paper]{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T1]{fontenc}
\\usepackage[french]{babel}
\\usepackage{amsmath}
\\usepackage{amsfonts}
\\usepackage{amssymb}
\\usepackage{graphicx}
\\usepackage{enumitem}
\\usepackage{geometry}
\\usepackage{xcolor}
\\usepackage{titlesec}
\\usepackage{fancyhdr}

\\geometry{left=2cm,right=2cm,top=2cm,bottom=2cm}

\\pagestyle{fancy}
\\fancyhf{}
\\fancyhead[L]{\\textbf{${examData.institution || 'Établissement'}}}
\\fancyhead[C]{\\textbf{${examData.subject} - ${examData.type} - CORRIGÉ}}
\\fancyhead[R]{\\textbf{${formatDate(examData.date)}}}
\\fancyfoot[C]{\\thepage}

\\titleformat{\\section}{\\Large\\bfseries}{}{0pt}{}

\\title{${examData.subject} - ${examData.type} - CORRIGÉ}
\\author{${examData.teacher}}
\\date{${formatDate(examData.date)}}

\\begin{document}

\\maketitle

\\vspace{1cm}

\\begin{center}
    \\textbf{\\Large CORRIGÉ TYPE}
\\end{center}

\\vspace{0.5cm}

\\begin{tabular}{|p{0.25\\textwidth}|p{0.7\\textwidth}|}
    \\hline
    \\textbf{Date} & ${formatDate(examData.date)} \\\\
    \\hline
    \\textbf{Matière} & ${examData.subject} \\\\
    \\hline
    \\textbf{Type d'épreuve} & ${examData.type} \\\\
    \\hline
    \\textbf{Durée} & ${examData.duration} \\\\
    \\hline
    \\textbf{Enseignant} & ${examData.teacher} \\\\
    \\hline
    \\textbf{Établissement} & ${examData.institution || 'Non spécifié'} \\\\
    \\hline
    \\textbf{Inspection/IESG} & ${examData.inspection || 'Non spécifié'} \\\\
    \\hline
    \\textbf{DRE} & ${examData.dre || 'Non spécifié'} \\\\
    \\hline
\\end{tabular}

\\vspace{1cm}
`;
            
            examData.exercises.forEach(exercise => {
                const correction = examData.corrections.find(c => c.exerciseId === exercise.id);
                
                let exercisePoints = 0;
                exercise.questions.forEach(q => exercisePoints += q.points);
                
                latexCode += `\\section*{Exercice ${romanize(exercise.id + 1)} : ${exercise.title} (${exercisePoints} points)}

${htmlToLatex(exercise.instructions)}

\\begin{enumerate}[label=\\textbf{\\arabic*.}, wide]
`;
                
                exercise.questions.forEach((question, index) => {
                    latexCode += `    \\item[\\hspace{1cm}] ${htmlToLatex(question.text)}
    \\hfill \\textbf{(${question.points} point${question.points > 1 ? 's' : ''})}
    
    \\vspace{0.3cm}
    
    \\noindent\\textbf{Correction:}
    
    ${htmlToLatex(correction.answers[index])}
    
    \\vspace{0.5cm}
`;
                });
                
                latexCode += `\\end{enumerate}

\\vspace{0.5cm}
`;
            });
            
            // Ajouter la correction manuelle au LaTeX
            if (examData.manualCorrection) {
                latexCode += `\\section*{Solution complète de l'évaluation}

${htmlToLatex(examData.manualCorrection)}

\\vspace{0.5cm}
`;
            }
            
            latexCode += `\\end{document}`;
            
            document.getElementById('latex-output').textContent = latexCode;
        }
        
        // Fonction pour copier le code LaTeX dans le presse-papier
        function copyLatexToClipboard() {
            const latexOutput = document.getElementById('latex-output');
            const textArea = document.createElement('textarea');
            textArea.value = latexOutput.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Code LaTeX copié dans le presse-papier!');
        }
        
        // Fonctions utilitaires
        function romanize(num) {
            const romanNumerals = [
                '', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X',
                'XI', 'XII', 'XIII', 'XIV', 'XV', 'XVI', 'XVII', 'XVIII', 'XIX', 'XX'
            ];
            
            return romanNumerals[num] || num;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }
        
        function htmlToLatex(html) {
            if (!html) return '';
            
            return html
                .replace(/<strong>(.*?)<\/strong>/g, '\\textbf{$1}')
                .replace(/<b>(.*?)<\/b>/g, '\\textbf{$1}')
                .replace(/<em>(.*?)<\/em>/g, '\\textit{$1}')
                .replace(/<i>(.*?)<\/i>/g, '\\textit{$1}')
                .replace(/<u>(.*?)<\/u>/g, '\\underline{$1}')
                .replace(/<h1>(.*?)<\/h1>/g, '\\section*{$1}')
                .replace(/<h2>(.*?)<\/h2>/g, '\\subsection*{$1}')
                .replace(/<h3>(.*?)<\/h3>/g, '\\subsubsection*{$1}')
                .replace(/<p>(.*?)<\/p>/g, '$1\n\n')
                .replace(/<br\s*\/?>/g, '\\\\')
                .replace(/<ul>(.*?)<\/ul>/gs, '\\begin{itemize}$1\\end{itemize}')
                .replace(/<ol>(.*?)<\/ol>/gs, '\\begin{enumerate}$1\\end{enumerate}')
                .replace(/<li>(.*?)<\/li>/g, '\\item $1')
                .replace(/<sub>(.*?)<\/sub>/g, '\\textsubscript{$1}')
                .replace(/<sup>(.*?)<\/sup>/g, '\\textsuperscript{$1}')
                .replace(/<div class="ql-align-center">(.*?)<\/div>/g, '\\begin{center}$1\\end{center}')
                .replace(/<div class="ql-align-right">(.*?)<\/div>/g, '\\begin{flushright}$1\\end{flushright}')
                .replace(/<[^>]*>/g, '') // Supprimer les balises HTML restantes
                .replace(/&nbsp;/g, ' ')
                .replace(/&amp;/g, '\\&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\n\s*\n/g, '\n\n') // Nettoyer les espaces multiples
                .trim();
        }
    </script>
</body>
</html>